<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VietKorTalk - ì‹¤ì‹œê°„ í†µì—­ê¸°</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-color: #f9f9f9;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .form-group {
      margin-top: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input,
    .form-group select,
    .form-group textarea,
    .form-group button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .form-group button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }
    .form-group button:hover {
      background-color: #45a049;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    .loading {
      color: green;
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>VietKorTalk â€“ ì‹¤ì‹œê°„ í†µì—­ê¸°</h2>

  <div class="form-group">
    <label for="apikey">ğŸ”‘ OpenAI API Key:</label>
    <input id="apikey" type="password" placeholder="sk-..." oninput="saveApiKey()" />
  </div>

  <div class="form-group">
    <label for="style">1. ë²ˆì—­ ìŠ¤íƒ€ì¼:</label>
    <select id="style">
      <option value="ì§ì—­">ì§ì—­</option>
      <option value="ì˜ì—­">ì˜ì—­</option>
    </select>
  </div>

  <div class="form-group">
    <label for="length">2. ë¬¸ì¥ ê¸¸ì´:</label>
    <select id="length">
      <option value="ê°„ê²°í•˜ê²Œ">ê°„ê²°í•˜ê²Œ</option>
      <option value="ë³´í†µ">ë³´í†µ</option>
      <option value="ê¸¸ê²Œ">ê¸¸ê²Œ</option>
    </select>
  </div>

  <div class="form-group">
    <label for="tone">3. ë§íˆ¬ ìŠ¤íƒ€ì¼:</label>
    <select id="tone">
      <option value="ì—°ì¸ì²˜ëŸ¼ ë‹¤ì •í•˜ê²Œ">ì—°ì¸ì²˜ëŸ¼ ë‹¤ì •í•˜ê²Œ</option>
      <option value="ì¹œêµ¬ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ">ì¹œêµ¬ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ</option>
      <option value="ë¹„ì¦ˆë‹ˆìŠ¤ ê³µì†í•˜ê²Œ">ë¹„ì¦ˆë‹ˆìŠ¤ ê³µì†í•˜ê²Œ</option>
      <option value="ë¬¸ì–´ì²´ë¡œ ì •ì¤‘í•˜ê²Œ">ë¬¸ì–´ì²´ë¡œ ì •ì¤‘í•˜ê²Œ</option>
      <option value="ë°˜ë§ë¡œ ì¥ë‚œìŠ¤ëŸ½ê²Œ">ë°˜ë§ë¡œ ì¥ë‚œìŠ¤ëŸ½ê²Œ</option>
      <option value="ì¡´ëŒ“ë§ë¡œ í¬ë©€í•˜ê²Œ">ì¡´ëŒ“ë§ë¡œ í¬ë©€í•˜ê²Œ</option>
    </select>
  </div>

  <div class="form-group">
    <label for="gender">4. í™”ì ì„±ë³„:</label>
    <select id="gender">
      <option value="ë‚¨ì„±">ë‚¨ì„±</option>
      <option value="ì—¬ì„±">ì—¬ì„±</option>
    </select>
  </div>

  <div class="form-group">
    <button onclick="startLiveRecognition()">ğŸ¤ ì‹¤ì‹œê°„ í†µì—­ ì‹œì‘</button>
  </div>

  <div class="form-group">
    <label for="inputText">ì…ë ¥ëœ ë¬¸ì¥:</label>
    <textarea id="inputText" placeholder="ì¸ì‹ëœ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
  </div>

  <div class="form-group">
    <label for="outputText">ë²ˆì—­ ê²°ê³¼:</label>
    <textarea id="outputText" placeholder="ë²ˆì—­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
  </div>

  <div class="form-group">
    <button onclick="speakText()">ğŸ”Š ìŒì„±ìœ¼ë¡œ ë‹¤ì‹œ ë“£ê¸°</button>
    <button onclick="copyOutputText()">ğŸ“‹ ë²ˆì—­ ê²°ê³¼ ë³µì‚¬</button>
  </div>

  <p id="status" class="loading"></p>

  <script>
    const inputText = document.getElementById('inputText');
    const outputText = document.getElementById('outputText');
    const apikeyInput = document.getElementById('apikey');
    const statusText = document.getElementById('status');

    let recognition = null;
    let lastSpeechTime = Date.now();
    let autoTranslateTimer = null;

    function saveApiKey() {
      localStorage.setItem('openai_api_key', apikeyInput.value);
    }

    window.onload = () => {
      const storedKey = localStorage.getItem('openai_api_key');
      if (storedKey) apikeyInput.value = storedKey;
    };

    async function startLiveRecognition() {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ko-KR';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = function (event) {
        const transcript = event.results[event.results.length - 1][0].transcript;
        inputText.value = transcript;
        lastSpeechTime = Date.now();
      };

      recognition.onerror = function (event) {
        statusText.textContent = "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + event.error;
      };

      recognition.onend = function () {
        recognition.start();
      };

      recognition.start();

      autoTranslateTimer = setInterval(() => {
        const now = Date.now();
        if (now - lastSpeechTime > 2000 && inputText.value.trim() !== '') {
          translateText(true);
          lastSpeechTime = Date.now() + 999999;
        }
      }, 1000);
    }

    async function translateText(autoSpeak = false) {
      const style = document.getElementById('style').value;
      const tone = document.getElementById('tone').value;
      const gender = document.getElementById('gender').value;
      const length = document.getElementById('length').value;
      const userInput = inputText.value.trim();
      const apiKey = localStorage.getItem('openai_api_key');

      if (!apiKey) {
        alert("API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      if (!userInput) {
        alert("ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const systemPrompt = `ë„ˆëŠ” ë² íŠ¸ë‚¨ì–´â†”í•œêµ­ì–´ í†µì—­ê°€ì•¼. í™”ìëŠ” ${gender}ì´ê³ , ${style} ê¸°ë°˜ìœ¼ë¡œ ë²ˆì—­í•˜ê³ , ë¬¸ì¥ì€ ${length} í‘œí˜„ìœ¼ë¡œ, ${tone} ë§íˆ¬ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„í•´ì¤˜. ì„±ë³„ì— ë§ëŠ” ì–¸ì–´ í‘œí˜„ì„ ì‚¬ìš©í•´.`;

      statusText.textContent = "ğŸ”„ ë²ˆì—­ ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userInput }
            ]
          })
        });

        const data = await response.json();
        if (data.choices && data.choices[0]) {
          outputText.value = data.choices[0].message.content.trim();
          if (autoSpeak) speakText();
        } else {
          outputText.value = "ë²ˆì—­ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
      } catch (error) {
        outputText.value = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message;
      } finally {
        statusText.textContent = "";
      }
    }

    function speakText() {
      if (recognition) recognition.stop();
      const utterance = new SpeechSynthesisUtterance(outputText.value);
      const gender = document.getElementById('gender').value;
      const voices = speechSynthesis.getVoices();
      const lang = /[\u3131-\uD79D]/ugi.test(outputText.value) ? 'ko-KR' : 'vi-VN';
      utterance.lang = lang;

      const preferredVoice = voices.find(voice =>
        voice.lang === lang &&
        (gender === 'ë‚¨ì„±' ? /male|man/i.test(voice.name + voice.voiceURI) : /female|woman/i.test(voice.name + voice.voiceURI))
      );
      if (preferredVoice) utterance.voice = preferredVoice;

      utterance.onend = () => { if (recognition) recognition.start(); };
      speechSynthesis.speak(utterance);
    }

    function copyOutputText() {
      navigator.clipboard.writeText(outputText.value)
        .then(() => alert("ë²ˆì—­ ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
        .catch(() => alert("ë³µì‚¬ ì‹¤íŒ¨ ğŸ˜¢"));
    }
  </script>
</body>
</html>
